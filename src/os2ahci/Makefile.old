###############################################################################
# Makefile.old - makefile for os2ahci driver, c600 tool chain
# NOTICE: This makefile is depreciated and is not guaranteed to work anymore.
#
# Copyright (c) 2011 thi.guten Software Development
# Copyright (c) 2011 Mensys B.V.
#
# Authors: Christian Mueller, Markus Thielen
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

###############################################################################
# Tool Chain
#

AS         = $(DDK)\tools\alp.exe
CC         = $(DDK)\base\tools\cl.exe
LD         = $(DDK)\base\tools\link.exe
MAPSYM     = $(DDK)\base\tools\mapsym.exe
ADDTOFILE  = ..\..\tools\AddToFile.cmd

AFLAGS     = -Mb
# In order to build the SMP safe version you must have the updated DDK and define OS2AHCI_SMP
CFLAGS     = -c -nologo -Asnw -W2 -G2ms -Zlpd -Fc -Zi #-DOS2AHCI_SMP
LFLAGS     = /noe /nod /packd /a:16 /batch /map /line

###############################################################################
# Environment

# main path to OS/2 DDK; this needs to be set before this makefile will work
!ifndef DDK
!error DDK must be set in the environment.
!endif

!ifndef VENDOR
VENDOR=Mensys BV
!endif

BLD_MAJOR=1
BLD_MINOR=26 # must be 2 digits
BLD_REV=0 # not used at this time

CC_INCLUDE   = -I..\include \
               -I$(DDK)\base\h \
               -I$(DDK)\base\ibmh \
               -I$(DDK)\base\src\dev\dasd\diskh \
               -I$(DDK)\base\src\dev\thinkpad\dockii\apmcalls

AS_INCLUDE   = -I:$(DDK)\base\inc \
               -I:$(DDK)\base\src\dev\dasd\diskinc

LIB_DIRS     = $(DDK)\base\lib\ \
               $(DDK)\base\src\dev\dasd\devhlp\ \
               $(DDK)\base\src\dev\thinkpad\dockii\apmcalls\ \

###############################################################################
# Main dependencies

TARGET   = os2ahci.add

LIBS     = addcalls dhcalls doscalls slibcep rmcalls apmcalls

SRCS     = init.asm libc.c os2ahci.c pci.c ahci.c ata.c atapi.c ctxhook.c \
           apm.c ioctl.c trace.c

OBJS     = init.obj libc.obj os2ahci.obj pci.obj ahci.obj ata.obj atapi.obj \
           ctxhook.obj apm.obj ioctl.obj trace.obj

INCS     = os2ahci.h ahci.h version.h ioctl.h ..\include\ahci-idc.h


all: $(TARGET)

clean:
    rm -f $(OBJS) $(TARGET) *.cod *.lst *.def *.map *.sym *.err *.lnk version.h

###############################################################################
# Object/source dependencies

init.obj:     init.asm   Makefile.old

libc.obj:     libc.c     Makefile.old $(INCS)

os2ahci.obj:  os2ahci.c  Makefile.old $(INCS) version.h ioctl.h

pci.obj:      pci.c      Makefile.old $(INCS)

ahci.obj:     ahci.c     Makefile.old $(INCS) ata.h atapi.h

ata.obj:      ata.c      Makefile.old $(INCS) ata.h

atapi.obj:    atapi.c    Makefile.old $(INCS) ata.h atapi.h

ctxhook.obj:  ctxhook.c  Makefile.old $(INCS) ata.h atapi.h

apm.obj:      apm.c      Makefile.old $(INCS)

ioctl.obj:    ioctl.c    Makefile.old $(INCS) ata.h atapi.h ioctl.h

trace.obj:    trace.c    Makefile.old $(INCS)

###############################################################################
# Action definitions (compile/link commands)

# emacs TAGS file creation
# NOTE: OS/2 emacs etags.exe expects an empty file named c:\dev\null...
tags:   $(SRCS) $(INCS) Makefile.old
    etags.exe $(SRCS) $(INCS) $(DDK)\base\src\dev\dasd\diskh\dhcalls.h \
    $(DDK)\base\src\dev\dasd\diskh\iorb.h \
    $(DDK)\base\h\bsedos16.h \
    $(DDK)\base\h\devcmd.h \
    $(DDK)\base\h\reqpkt.h

version.h: Makefile.old
    @echo /* Autogenerated by Makefile.old */ >version.h
    @echo #define VERSION $(BLD_MAJOR)$(BLD_MINOR) /* driver version (2 implied decimals) */ >>version.h
    @$(ADDTOFILE) version.h,#define BLD_YEAR,DATEYEAR
    @$(ADDTOFILE) version.h,#define BLD_MONTH,DATEMONTH
    @$(ADDTOFILE) version.h,#define BLD_DAY,DATEDAY

.asm.obj:
    $(AS) $(AFLAGS) $(AS_INCLUDE) $*.asm
#    wdis -l $*.obj

.c.obj:
    $(CC) $(CFLAGS) $(CC_INCLUDE) $*.c
#    wdis -l $*.obj

os2ahci.def: os2ahci.def.template Makefile.old
    copy os2ahci.def.template os2ahci.def
	@$(ADDTOFILE) os2ahci.def,Description,BLDLEVEL,$(VENDOR),$(BLD_MAJOR).$(BLD_MINOR),AHCI Driver (c) Mensys BV 2013

$(TARGET): $(OBJS) os2ahci.def Makefile.old
    $(LD) $(LFLAGS) $(OBJS),$(TARGET),$*.map,$(LIB_DIRS) $(LIBS),$*.def
    $(MAPSYM) os2ahci
